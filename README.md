# cf-ops-automation-broker 

[![CI](https://circleci.com/gh/orange-cloudfoundry/cf-ops-automation-broker.svg?style=shield&circle-token=:circle-token)](https://circleci.com/gh/orange-cloudfoundry/cf-ops-automation-broker) [![FOSSA Status](https://app.fossa.io/api/projects/git%2Bgithub.com%2Forange-cloudfoundry%2Fcf-ops-automation-broker.svg?type=shield)](https://app.fossa.io/projects/git%2Bgithub.com%2Forange-cloudfoundry%2Fcf-ops-automation-broker?ref=badge_shield) [![Coverity Scan](https://img.shields.io/coverity/scan/3997.svg)](https://scan.coverity.com/projects/orange-cloudfoundry-cf-ops-automation-broker)

On demand dedicated services through COA concourse pipeline engine

## Overview

COAB is a generic service broker which enables operators to provide on-demand dedicated services from available building blocks:
* terraform modules provisionning
   * [cloudfoundry resources](https://github.com/mevansam/terraform-provider-cf), such as cloudfoundry applications
   * [K8S resources](https://www.terraform.io/docs/providers/kubernetes/), e.g. through [K8S charts](https://github.com/mcuadros/terraform-provider-helm)
   * Saas resources such as [cloudflare](https://www.terraform.io/docs/providers/cloudflare/)
* existing bosh releases with service brokers offering shared service plans (e.g [cassandra-cf-service-boshrelease](https://github.com/orange-cloudfoundry/cassandra-cf-service-boshrelease/))

COAB leverages concourse-based pipelines to deploy and operate the dedicated resources, managed by the [cf-ops-automation (COA)](https://github.com/orange-cloudfoundry/cf-ops-automation) collaboration framework.

Here are some slides to provide more background to this project:

[![image](https://user-images.githubusercontent.com/4748380/46364595-85ead380-c676-11e8-947d-2c6b32516a43.png)](https://docs.google.com/presentation/d/1ChrpHQRxwdLzpt4m4sLe2PVJICqP0bCo9B5ffCPv57Q/edit?usp=sharing)

The following diagram illustrates COAB interactions
![Overview of COAB interactions](coab-overview.png)

<br/> 1- A user requests a dedicated service instance (or binding) through its prefered platform (CF or K8S service catalog) which in turn propagate the request to COAB as an [OSB API call](https://github.com/openservicebrokerapi/servicebroker)
<br/> 2- COAB requests an on-demand dedicated pipeline to the COA templating engine, by writing to Git repos
<br/> 3- COA templating engine reads the git repos 
<br/> 4- COA generates on-demand pipelines that deploys and operate the requested dedicate service resources
<br/> <br/> 5- The dedicated concourse pipeline provisions resources supporting the dedicated resource (in form of a bosh deployment, a terraform module, or a CF app)
<br/> 7- the dedicated concourse pipeline records the outcome of the dedicated service in git
<br/> 8- the dedicated concourse pipeline (and its underlying tools such as bosh director) records the credentials necessary to consumme the decicated service instance/binding
<br/> 9- COAB pulls the dedicated service provisionning completion status from git
<br/> 10a)- COAB delegates OSB API calls to nested service brokers, delegating credentials management to them
<br/> 10b)- alternatively COAB fetches dedicated service credentials generated by the pipeline from credhub
<br/> 11- COAB returns service instance/bindings to user





## Status

This project is still in a beta state providing POC broker releases for CloudFlare and Cassandra use-cases above. Next step is to generalize the approach.

## Getting Started

Deploy the broker as a CF app:
* The CF manifest.yml file would be available in [orange-cloudfoundry/paas-templates](https://github.com/orange-cloudfoundry/paas-templates) repo
   * The documentation reference for supported and required environment variables is in the [integration tests properties](cf-ops-automation-bosh-broker/src/test/resources/application.properties). 
   * The broker does not require stateful data service to be bound. 

### Configuring the service broker catalog

Use `spring.cloud.openservicebroker.catalog` environment variable to set catalog config in a YAML format. See [spring-cloud-open-service-broker](https://docs.spring.io/spring-cloud-open-service-broker/docs/current/reference/html5/#_providing_a_catalog_using_properties) for a sample YML and raw properties configuration

### Troubleshooting COAB

#### Spring boot debug mode

Enable [springboot debug/trace mode](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-logging.html#boot-features-logging-console-output) to diagnose beans configuration. When running COAB as a cf app, use the 
commands below to turn on spring boot debug mode. 


```bash
cf set-env my-app DEBUG true
```

and when finished

```bash
cf unset-env my-app DEBUG true
```

#### Increase logging levels

Increase verbosity for COAB classes:
- default levels are in [cf-ops-automation-bosh-broker/src/main/resources/application.yml](cf-ops-automation-bosh-broker/src/main/resources/application.yml)
- see some frequently used levels in [cf-ops-automation-bosh-broker/src/test/resources/application.properties](cf-ops-automation-bosh-broker/src/test/resources/application.properties) and [cf-ops-automation-broker-core/src/test/resources/application.yml](cf-ops-automation-broker-core/src/test/resources/application.yml) 

#### Expose more spring actuator endpoints

By default, COAB only exposed the health and info endpoints and make them accessible without authentication.

For debug purposes only, expose all actuator endpoints which are disabled by default, see related [spring manual](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html#production-ready-endpoints-exposing-endpoints) They currently require broker basic auth.

```yml
management.endpoints.web.exposure.include: "*"
```

See also, associated [actuator endpoints API doc](https://docs.spring.io/spring-boot/docs/current/actuator-api/html/)


## Authoring a new COAB-based service

Prepare a standard COA bosh deployment, see [COA documentation](https://github.com/orange-cloudfoundry/cf-ops-automation#template-engine-reference-documentation)

such as 

```
$ tree coab-depls/mongodb

coab-depls/mongodb
|-- deployment-dependencies.yml
`-- template
    |-- coab-operators.yml
    |-- add-prometheus-operators.yml
    |-- add-shield-operators.yml
    |-- mongodb-vars.yml
    `-- mongodb.yml
    
    
$ cat coab-depls/mongodb/template/coab-operators.yml 

#replace deployment name
- type: replace
  path: /name
  value: ((deployment_name))

#replace external host
- type: replace
  path: /instance_groups/name=mongodb-broker/jobs/name=route-registrar/properties/route_registrar/external_host
  # deployment name is of format model-deployment-short-alias + "_" + <service-instance-id>
  value: mongodb-broker-((deployment_name)).((!/secrets/cloudfoundry_system_domain))

```

COAB would generate the following for service instance provisionning/updates:

```
$tree coab-depls/m_f49911f7-b69a-4aba-afdf-23fd11014278

coab-depls/m_f49911f7-b69a-4aba-afdf-23fd11014278
|-- deployment-dependencies.yml -> ../../template/mongodb/deployment-dependencies.yml
`-- template
    |-- coab-operators.yml -> ../../mongodb/operators/coab-operators.yml
    |-- mongodb-vars.yml -> ../../mongodb/template/mongodb-vars.yml
    |-- m_f49911f7-b69a-4aba-afdf-23fd11014278.yml -> ../../mongodb/template/mongodb.yml
    `-- coab-vars.yml
    
```

The `coab-vars.yml` file contains the open service broker api standardized input for both service [provisionning](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#provisioning) and [update](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#updating-a-service-instance). The following example below shows a dummy example with a user passing arbirary params in a `cf update-service-instance` along with a service plan update. 

```
$cat coab-depls/m_f49911f7-b69a-4aba-afdf-23fd11014278/coab-vars.yml

---
deployment_name: "m_f49911f7-b69a-4aba-afdf-23fd11014278"
instance_id: "f49911f7-b69a-4aba-afdf-23fd11014278"
service_id: "mongodb-service_definition_id"
plan_id: "mongodb-plan_guid"
context:
  platform: "cloudfoundry"
  user_guid: "user_guid1"
  space_guid: "space_guid1"
  organization_guid: "org_guid1"
parameters:
  cacheRatio: 0.8642
  cacheSizeMb: 10
  slowQuery: false
previous_values:
  plan_id: "previous_plan_guid"     
```

Note: for security reasons, input validation is applied on the name and value of arbitrary params to prevent various injections (such as reading from credhub, spruce, file system injection, yml loading or reference expansions), and only so alphabetical characters, numbers are supported.

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) document